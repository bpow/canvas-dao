<document>
  <properties>
  </properties>
  <body>
    <section name="LocatedVariant Specification">
      <p>Variants are represented in CANVAS as "locvars" (located
      variants). This representation predates representations such as
      what is used in VCF or GA4GH (and may change in the future as
      other specifications solidify within the community).</p>
      <subsection name="Columns in the 'var.loc_var' table">
<pre>
| column            |                                                                                          |
| ----------------- | ---------------------------------------------------------------------------------------- |
| loc_var_id        | generated primary key                                                                    |
| ref_id            | foreign key to ref.genome_ref for each genome assembly                                   |
| ref_ver_accession | chromosome (versioned accession) of the reference sequence                               |
| pos               | 1-based inclusive start position: the 1st base altered in the variant (EXCEPT for ins)   |
| type              | one of “ref”, “snp”, “ins”, “del”, “sub”                                                 |
| seq               | the “alt” sequence for a variant (EXCEPT for "del", where it is equal to the ref)        |
| end_pos           | 1-based exclusive end position (so the first base that is *not* affected by the variant) |
| ref               | reference sequence at the site enclosed by pos:end_pos (inclusive left, exclusive right) |
</pre>
      </subsection>
    </section>
    <section name="The process of producing a LocatedVariant">
      
      <subsection name="Inputs">
	<ul>
	  <li>persisted as input: ref_id, ref_ver_accession</li>
	  <li>oneBasedStart (e.g., 1-based start position from VCF file, or VariantContext.getStart() )</li>
	  <li>refAllele</li>
	  <li>altAllele</li>
	</ul>
      </subsection>
      
      <subsection name="1. Trimming">
	<ul>
	  <li>Common prefix and suffix are removed from both refAllele and altAllele, leaving only the part that is “different” between the two alleles.</li>
	  <li>The ‘offset' for new start is calculated as the length of the prefix that is removed</li>
	  <li>EXCEPTION for “ref” alleles, which are not trimmed because by definition they ref == alt at these positions</li>	    
	</ul>	  
      </subsection>
      
      <subsection name="2. Determination of ‘type’ (after trimming…)">
	<ul>
 	  <li>“ref” variants will have trimmedRefAllele == trimmedAltAllele, else</li>
 	  <li>“snp" variants will have len(trimmedRefAllele) == len(trimmedAltAllele) == 1, else</li>
 	  <li>“ins” variants will have len(trimmedRefAllele) == 0, else</li>
 	  <li>“del” variants will have len(trimmedAltAllele) == 0, else</li>
 	  <li>other variants are of type “sub”</li>
	</ul>	  
      </subsection>
      
      <subsection name="3. Representation of ref, seq, pos, end_pos:">
	<subsection name="ref">
	  <ul>
 	    <li>ref = value of trimmedRefAllele (note: this will also be the base a position ‘pos’ in the reference sequence)</li>
 	    <li>seq = value of trimmedAltAllele</li>
 	    <li>pos = oneBasedStart + offset</li>
 	    <li>end_pos = pos + length(ref) (note: this will always be pos+1 so long as “ref”-type alleles are always single-base</li>
	  </ul>
	</subsection>
	<subsection name="snp">
	  <ul>
 	    <li>ref = value of trimmedRefAllele (note: this will also be the base at position ‘pos’ in the reference sequence)</li>
 	    <li>seq = value of trimmedAltAllele</li>
 	    <li>pos = oneBasedStart + offset (position of the changed base)</li>
 	    <li>end_pos = pos + length(ref) = pos + 1</li>
	  </ul>
	</subsection>
	<subsection name="ins">
	  <ul>
 	    <li>ref = value of trimmedRefAllele (which in this case happens to be the empty string)</li>
 	    <li>seq = value of trimmedAltAllele</li>
 	    <li>pos = oneBasedStart + offset - 1 (so pos is the base *before* the insertion)</li>
 	    <li>end_pos = oneBasedStart = pos + 1 (end_pos is the position *after* the insertion)</li>
	  </ul>
	</subsection>
	<subsection name="del">
	  <ul>
 	    <li>ref = value of trimmedRefAllele</li>
 	    <li>seq = valued of trimmedRefAllele (NOTE: this is weird, because one might expect this to be the value of trimmedAltAllele, which would be the empty string)</li>
 	    <li>pos = oneBasedStart + offset (position of the first deleted base)</li>
 	    <li>end_pos = pos + length(ref) (position of the first undeleted base)</li>
	  </ul>
	</subsection>
	<subsection name="sub">
	  <ul>
 	    <li>ref = value of trimmedRefAllele</li>
 	    <li>seq = value of trimmedAltAllele</li>
 	    <li>pos = oneBasedStart + offset</li>
 	    <li>end_pos = pos + length(ref)</li>
	  </ul>
	</subsection>	  
      </subsection>
      <subsection name="Things to be careful about//exceptions/inconsistencies">
	<ol>
	  <li>pos is the input oneBasedStart plus the size of the removed prefix EXCEPT for “ins” type where this is decremented by 1</li>
	  <li>end_pos is pos + length(ref) for all types EXCEPT for “ins”, where you add 1 even though length(ref) is 0</li>
	  <li>‘seq’ is the sequence that you would now see between pos and end_pos after the modification EXCEPT for “del” variants</li>
	</ol>
      </subsection>
    </section>
  </body>
</document>
